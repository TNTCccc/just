/*!
 * JUST JavaScript template engine v0.1.7
 * https://github.com/baryshev/just
 *
 * Copyright 2012, Vadim M. Baryshev <vadimbaryshev@gmail.com>
 * Licensed under the MIT license
 * https://github.com/baryshev/just/LICENSE
 *
 * Includes parts of async
 * https://github.com/caolan/async
 * Copyright 2010 Caolan McMahon
 * Released under the MIT license
 *
 * Includes parts of node
 * https://github.com/joyent/node
 * Copyright Joyent, Inc. and other Node contributors
 * Released under the MIT license
 *
 * Includes Cross-Browser Split 1.0.1
 * http://xregexp.com/
 * Copyright Steven Levithan <stevenlevithan.com>
 * Released under the MIT license
 */
(function(){"use strict";var fs,path,async=function(){var a={},b=function(a,b){var c;if(a.forEach)return a.forEach(b);for(c=0;c<a.length;c++)b(a[c],c,a)},c=function(a,c){if(a.map)return a.map(c);var d=[];return b(a,function(a,b,e){d.push(c(a,b,e))}),d},d=function(a,b,d,e){var f=[];b=c(b,function(a,b){return{index:b,value:a}}),a(b,function(a,b){d(a.value,function(c,d){f[a.index]=d,b(c)})},function(a){e(a,f)})},e=function(b){return function(){var c=Array.prototype.slice.call(arguments);return b.apply(null,[a.forEach].concat(c))}};return a.forEach=function(a,c,d){if(!a.length)return d();var e=0;b(a,function(b){c(b,function(b){b?(d(b),d=function(){}):(e++,e===a.length&&d())})})},a.map=e(d),a.parallel=function(b,c){c=c||function(){},b.constructor===Array&&a.map(b,function(a,b){a&&a(function(a){var c=Array.prototype.slice.call(arguments,1);c.length<=1&&(c=c[0]),b.call(null,a,c)})},c)},a}(),JUST=function(newOptions){var options={open:"<%",close:"%>",ext:".html",useCache:!0,watchForChanges:!1,root:"."},trimExp=/^\s+|\s+$/g,escapeExp=/([.*+?\^=!:${}()|\[\]\/\\])/g,STATE_RAW=0,STATE_PARTIAL=1,STATE_EXTEND=2,STATE_CONDITION=3,STATE_ELSE=4,STATE_SWITCH=5,STATE_CASE=6,STATE_DEFAULT=7,STATE_LOOP=8,cache={},loaders={},watchers={},regExpEscape=function(a){return String(a).replace(escapeExp,"\\$1")},parse=function(a){var b=1,c=["with (this.data) { with (this.customData) { this.buffer.push('"],d=a.split(new RegExp(regExpEscape(options.open)+"((?:.|[\r\n])+?)(?:"+regExpEscape(options.close)+"|$)")),e,f,g,h,i,j,k,l,m;for(f=0,e=d.length;f<e;f++){g=d[f];if(f%2===1){j="this.line="+b,l=1,m=STATE_RAW;switch(g.charAt(0)){case"@":h="',("+j+", this.partial(",i=")),'",m=STATE_PARTIAL;break;case"!":h="',("+j+", this.extend(",i=")),'",m=STATE_EXTEND;break;case"*":h="',("+j+", this.child('",i="')),'";break;case"[":h="');"+j+";this.blockStart('",i="');this.buffer.push('";break;case"]":h="');"+j+";this.blockEnd(",i=");this.buffer.push('";break;case"=":h="',("+j+", ",i="),'";break;case"?":h="');"+j+";",i="this.buffer.push('",m=STATE_CONDITION;break;case":":h="');"+j+";}else",i="this.buffer.push('",m=STATE_ELSE;break;case"|":h="');"+j+";",i="this.buffer.push('",m=STATE_LOOP;break;default:h="');"+j+";",i=";this.buffer.push('",l=0}switch(m){case STATE_RAW:c.push(h,g.substr(l).replace(trimExp,""),i);break;case STATE_CONDITION:k=g.substr(l).replace(trimExp,""),k.length?c.push(h,"if(",k,"){",i):c.push(h,"}",i),k=undefined;break;case STATE_ELSE:k=g.substr(l).replace(trimExp,""),k.length?c.push(h," if(",k,"){",i):c.push(h,"{",i),k=undefined;break;case STATE_PARTIAL:case STATE_EXTEND:k=g.substr(l).replace(trimExp,"").split(/\s+/),k=["'"+k[0]+"'",k.splice(1).join(" ")],k[1].length?k=k.join(","):k=k[0],c.push(h,k,i),k=undefined;break;case STATE_LOOP:k=g.substr(l).replace(trimExp,"").split(/\s+/),k[0].length?c.push(h,k[0],".forEach(function(",k[1],"){this.buffer.push('"):c.push("');"+j+";}, this);this.buffer.push('"),k=undefined}}else c.push(g.replace(/[\\']/g,"\\$&").replace(/\r/g," ").replace(/\n/g,"\\n"));b+=g.split(/\n/).length-1}return c.push("'); } } return this.buffer;"),c=c.join(""),new Function(c)},loaded=function(a,b,c){async.forEach(loaders[b],function(b,d){b(a,c),d()},function(){delete loaders[b]})},read=function(file,callback){if(Object.prototype.toString.call(options.root)==="[object Object]")try{var data=eval("(options.root."+file+")");Object.prototype.toString.call(data)==="[object String]"?callback(undefined,data):callback("Failed to load template")}catch(e){callback(e)}else fs.readFile(file,"utf8",callback)},load=function(a,b){options.useCache&&cache[a]?b&&b(undefined,cache[a]):loaders[a]?b&&loaders[a].push(b):(loaders[a]=[],b&&loaders[a].push(b),read(a,function(b,c){if(b)loaded(b,a,undefined);else try{var d=parse(c);loaded(undefined,a,d),options.useCache&&(cache[a]=d),options.watchForChanges&&(watchers[a]=fs.watch(a,function(){watchers[a].close(),delete watchers[a],delete cache[a]}))}catch(e){e.message=e.message+" in "+a,loaded(e,a,undefined)}}))},Template=function(a,b,c){this.file=a,Object.prototype.toString.call(options.root)==="[object String]"&&(this.file=path.normalize(options.root+"/"+a+options.ext)),this.data=b,this.customData=c||{},this.buffer=[],this.tmpBuffer=undefined,this.watcher=undefined,this.line=1,this.partials=[],this.childData=[],this.childError=undefined,this.childCallback=undefined,this.callback=undefined,this.blocks={}};Template.prototype.blockStart=function(a){this.tmpBuffer=this.buffer,this.blocks[a]||(this.blocks[a]=[]),this.blocks[a].length?this.buffer=[]:this.buffer=this.blocks[a]},Template.prototype.blockEnd=function(){this.buffer=this.tmpBuffer,delete this.tmpBuffer},Template.prototype.partial=function(a,b){var c=[],d=new Template(a,this.data,b);return this.partials.push(function(a){d.render(function(b,d){b||c.push(d),a(b)})}),c},Template.prototype.extend=function(a,b){var c=new Template(a,this.data,b),d=this.callback;return c.blocks=this.blocks,this.callback=function(a,b){a?(c.childError=a,c.childCallback&&c.childCallback(a)):(c.childData.push(b),c.childCallback&&c.childCallback())},c.partials.push(function(a){c.childError?a(c.childError):c.childData.length?a():c.childCallback=a}),c.render(d),""},Template.prototype.child=function(a){return a&&a.length?(this.blocks[a]||(this.blocks[a]=[]),this.blocks[a]):this.childData},Template.prototype.render=function(a){var b=this;this.callback=a,load(this.file,function(a,c){if(a)b.callback&&b.callback(a,undefined);else try{var d=c.call(b);async.parallel(b.partials,function(a){var c="",e,f;if(!a)for(f=0,e=d.length;f<e;f++)c+=Array.isArray(d[f])?d[f].join(""):d[f];b.callback&&b.callback(a,c)})}catch(e){e.message=e.message+" in "+b.file+" on line "+b.line,b.callback&&b.callback(e,undefined)}})},this.configure=function(a){var b;a=a||{};for(b in options)options[b]=a[b]||options[b]},this.render=function(a,b,c){var d=new Template(a,b);d.render(c)},this.configure(newOptions)};if(typeof module!="undefined"&&module.exports)fs=require("fs"),path=require("path"),module.exports=JUST;else{Array.prototype.filter||(Array.prototype.filter=function(a,b){var c=this.length,d=[],e,f;if(typeof a!="function")throw new TypeError;for(e=0;e<c;e++)e in this&&(f=this[e],a.call(b,f,e,this)&&d.push(f));return d}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){var c=this.length,d;if(typeof a!="function")throw new TypeError;for(d=0;d<c;d++)d in this&&a.call(b,this[d],d,this)}),Array.isArray||(Array.isArray=function(a){return Object.prototype.toString.call(a)==="[object Array]"});var cbSplit;cbSplit||(cbSplit=function(a,b,c){if(Object.prototype.toString.call(b)!=="[object RegExp]")return cbSplit.nativeSplit.call(a,b,c);var d=[],e=0,f=(b.ignoreCase?"i":"")+(b.multiline?"m":"")+(b.sticky?"y":""),g,h,i,j;b=new RegExp(b.source,f+"g"),a+="",cbSplit.compliantExecNpcg||(g=new RegExp("^"+b.source+"$(?!\\s)",f));if(c===undefined||+c<0)c=Infinity;else{c=Math.floor(+c);if(!c)return[]}while(h=b.exec(a)){i=h.index+h[0].length;if(i>e){d.push(a.slice(e,h.index)),!cbSplit.compliantExecNpcg&&h.length>1&&h[0].replace(g,function(){var a;for(a=1;a<arguments.length-2;a++)arguments[a]===undefined&&(h[a]=undefined)}),h.length>1&&h.index<a.length&&Array.prototype.push.apply(d,h.slice(1)),j=h[0].length,e=i;if(d.length>=c)break}b.lastIndex===h.index&&b.lastIndex++}return e===a.length?(j||!b.test(""))&&d.push(""):d.push(a.slice(e)),d.length>c?d.slice(0,c):d},cbSplit.compliantExecNpcg=/()??/.exec("")[1]===undefined,cbSplit.nativeSplit=String.prototype.split),String.prototype.split=function(a,b){return cbSplit(this,a,b)},window.JUST=JUST,path=function(){var a=function(a,b){var c=0,d,e;for(d=a.length-1;d>=0;d--)e=a[d],e==="."?a.splice(d,1):e===".."?(a.splice(d,1),c++):c&&(a.splice(d,1),c--);if(b)while(c)a.unshift(".."),c--;return a},b=function(b){var c=b.charAt(0)==="/",d=b.slice(-1)==="/";return b=a(b.split("/").filter(function(a){return!!a}),!c).join("/"),!b&&!c&&(b="."),b&&d&&(b+="/"),(c?"/":"")+b};return{normalize:b}}();var AjaxObject=function(a,b){var c=this;this.updating=!1,this.abort=function(){c.updating&&(c.updating=!1,c.AJAX.abort(),c.AJAX=null)},this.update=function(){return c.updating?!1:(c.AJAX=null,window.XMLHttpRequest?(c.AJAX=new XMLHttpRequest,c.AJAX.overrideMimeType&&c.AJAX.overrideMimeType("text/html")):c.AJAX=new ActiveXObject("Microsoft.XMLHTTP"),c.AJAX===null?!1:(c.AJAX.onreadystatechange=function(){c.AJAX.readyState===4&&(c.updating=!1,c.callback(c.AJAX.responseText,c.AJAX.status,c.AJAX.responseXML),c.AJAX=null)},c.updating=new Date,c.AJAX.open("GET",a,!0),c.AJAX.send(null),!0))},this.callback=b||function(){}};fs=function(){var a=function(a,b,c){var d=new AjaxObject(a,function(a,b){b<200||b>399?c("Failed to load template"):c(undefined,a)});try{d.update()}catch(e){c(e)}},b=function(){};return{readFile:a,watch:b}}()}})();